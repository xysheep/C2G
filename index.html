
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>Generating 2D Gating Hierarhcy from Clustered Cytometry Data</title><meta name="generator" content="MATLAB 9.1"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2017-08-07"><meta name="DC.source" content="demo.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; } 

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><h1>Generating 2D Gating Hierarhcy from Clustered Cytometry Data</h1><!--introduction--><p>Our algorithm cluster-to-gates(C2G) can visualize a clustered cytometry data in 2D gating hierarchy. The overall input to C2G are two variables: "data" and "label". "data" is a N-by-M matrix where N is the number of cells and M is the number of markers. "label" is a N-by-1 matrix and this matrix represent which cluster each cell belongs to (0 for ungated cells).  In this page, we will demonstrate how to use C2G to generate gating hierarchy on a simulated data and on a CYTOF dataset that are manually gated. The software and testing data can be downloaded <b>here</b> .</p><!--/introduction--><h2>Contents</h2><div><ul><li><a href="#1">Initialization and load the simulated data</a></li><li><a href="#2">Visualize the simulated data and pre-clustered simulated data in 3D</a></li><li><a href="#3">Run the analysis on the simulated data</a></li><li><a href="#4">Load CYTOF datasets</a></li><li><a href="#5">Generate gating hierarchy for manually gated populations</a></li><li><a href="#6">Generate gating hierarchy for K-means defined populations (K=10)</a></li><li><a href="#7">Scaffold CyTOF data</a></li></ul></div><h2 id="1">Initialization and load the simulated data</h2><p>This simulated data set contain 20000 cells, which consist of 5 populations.Two of the populations are addressed as known and labeled as 1 and 2. The cells in other populations are labeled 0 which means "ungated". A visualization of the original data is also shown in the following sections.</p><pre class="codeinput">addpath(<span class="string">'src'</span>)
addpath(<span class="string">'libs'</span>)
load(<span class="string">'testdata/simulated.mat'</span>,<span class="string">'data'</span>,<span class="string">'label'</span>);
markernames ={<span class="string">'Marker 1'</span>,<span class="string">'Marker 2'</span>,<span class="string">'Marker 3'</span>};
fprintf(<span class="string">'Size of "data" is %d-by-%d\n'</span>,size(data));
fprintf(<span class="string">'Size of "label" is %d-by-%d\n'</span>,size(label));
</pre><pre class="codeoutput">Size of "data" is 20000-by-3
Size of "label" is 20000-by-1
</pre><h2 id="2">Visualize the simulated data and pre-clustered simulated data in 3D</h2><p>In real application, this section is not necessay.</p><pre class="codeinput">col = [0.8 0.8 0.8;hsv(length(unique(label))-1)];
figure(<span class="string">'Position'</span>,[680 478 560 420]);
scatter3(data(:,1),data(:,2),data(:,3),1,col(label+1,:));
xlabel(<span class="string">'Marker 1'</span>)
ylabel(<span class="string">'Marker 2'</span>)
zlabel(<span class="string">'Marker 3'</span>)
axis([-5 15 -5 15 -5 15]);
</pre><img vspace="5" hspace="5" src="html/demo_01.png" alt=""> <h2 id="3">Run the analysis on the simulated data</h2><p>This section perform the analysis on the simulated data. If your data have no "ungated" cells, preclustered step can be skipped. If you skip precluster, the second and third parameter in function "C2G" should be the same. Compute local density step is also optional, it can decrease time cost in computing density when you want to try different parameter setting in "C2G". If you skipped it, no need to input the fourth parameter in "C2G".</p><pre class="codeinput"><span class="comment">% Precluster the simulated data</span>
rng(9464);
preclustered_label = cluster_ungated(data,label);

<span class="comment">% Call main part of the program and return a object m that store the</span>
<span class="comment">% results. The option "ignore_ratio" mean percentage of low density cells</span>
<span class="comment">% ignored when compute overlap between different populations</span>

m = C2G(data,preclustered_label,label,<span class="string">'markernames'</span>,markernames,<span class="string">'showdetail'</span>,false);
<span class="comment">% Draw the obtained gating hierarchy</span>
<span class="comment">% Show statistics</span>
m.view_gates(data,markernames,<span class="string">'n_lines'</span>,1,<span class="string">'onepanel'</span>,true);
outtable = m.show_f_score(label);
</pre><pre class="codeoutput">Population	Gate	    TP	    FP	    FN	F-score
         1	   3	  5411	    18	     0	  0.998
         2	   4	  9166	     1	     0	  1.000
Normalized Mutual Information = 0.996
</pre><img vspace="5" hspace="5" src="html/demo_02.png" alt=""> <h2 id="4">Load CYTOF datasets</h2><p>Read multiple fcs files. Each fcs file correspond to one cell population Automatically generate cell labels based on fsc files. FCS files are store in the "test" folder. "CD4_Effmen.fcs", "CD4_naive.fcs", and "CD8_naive.fcs" are cells of target populations and "ctr.fcs" contain all cells. Only work with surface protein markers.</p><pre class="codeinput">clear
close <span class="string">all</span>
addpath(<span class="string">'src'</span>)
addpath(<span class="string">'libs'</span>)
fdname = <span class="string">'testdata'</span>;
[ori_data,ori_l,ori_markers]=load_mul_fcs(fdname,<span class="string">'ctr.fcs'</span>);

surface_idx = [3 4 6 8 9 11 12 13 22 24 25 27];
data = ori_data(:,surface_idx);
markers = ori_markers(surface_idx);
n_markers = length(markers);
</pre><h2 id="5">Generate gating hierarchy for manually gated populations</h2><pre class="codeinput"><span class="comment">% Precluster the ungated cells</span>
rng(9464)
label = cluster_ungated(data,ori_l);
<span class="comment">% Perform the anlysis</span>
m_ori = C2G(data,label,ori_l,<span class="string">'markernames'</span>,markers,<span class="string">'showdetail'</span>,false);
<span class="comment">% Visualize the results</span>
m_ori.view_gates(data,markers,<span class="string">'n_lines'</span>,3,<span class="string">'ignore_small'</span>,0,<span class="string">'onepanel'</span>,true);
m_ori.show_f_score(ori_l);
</pre><pre class="codeoutput">Population	Gate	    TP	    FP	    FN	F-score
         1	   7	   216	    13	     8	  0.954
         2	   8	  2267	    30	    78	  0.977
         3	   6	   488	    46	    37	  0.922
Normalized Mutual Information = 0.893
</pre><img vspace="5" hspace="5" src="html/demo_03.png" alt=""> <h2 id="6">Generate gating hierarchy for K-means defined populations (K=10)</h2><pre class="codeinput">rng(9464)
km_l = kmeans(data,10);
new_km_l = km_l; <span class="comment">% Since all populiations is known, no need to pre-cluster</span>
<span class="comment">% Perform the anlysis</span>
m_km = C2G(data,km_l,km_l,<span class="string">'markernames'</span>,markers,<span class="string">'showdetail'</span>,false);
<span class="comment">% Visualize the results</span>
m_km.view_gates(data,markers,<span class="string">'n_lines'</span>,4,<span class="string">'ignore_small'</span>,200);
m_km.show_f_score(km_l);
</pre><pre class="codeoutput">Population	Gate	    TP	    FP	    FN	F-score
         1	  27	   746	   155	    42	  0.883
         2	  16	   798	   139	   115	  0.863
         3	  32	  1204	   176	    85	  0.902
         4	  24	  1853	   243	   277	  0.877
         5	  31	  1418	   161	    74	  0.923
         6	  18	  1163	   165	   208	  0.862
         7	  21	   714	    27	    38	  0.956
         8	  20	   138	    12	    18	  0.902
         9	  22	   609	    38	    46	  0.935
        10	  23	   192	    15	    26	  0.904
Normalized Mutual Information = 0.780
</pre><img vspace="5" hspace="5" src="html/demo_04.png" alt=""> <img vspace="5" hspace="5" src="html/demo_05.png" alt=""> <h2 id="7">Scaffold CyTOF data</h2><p>This is a larger CyTOF dataset with 140k cells and 21 protein markers. This dataset is clustered by k-means where k equal to 10. This part will take around 10 minutes on a desktop.</p><pre class="codeinput">[ori_data, marker] = readfcs_v2(<span class="string">'testdata/bigdata/TIN_BLD1_Untreated_Day3.fcs'</span>);
<span class="comment">% Transform the CyTOF</span>
data = flow_arcsinh(ori_data,5);
<span class="comment">% Select protein markers</span>
marker_idx = [10,16,17,18,19,21,22,24,29,31,32,33,39,40,41,46,47,49,50,51,52];
d = data(marker_idx,:)';
rng(9464);
label = kmeans(d,10);
<span class="comment">% Perform the anlysis</span>
tic;m = C2G(d, label, label,<span class="string">'markernames'</span>,marker(marker_idx),<span class="string">'showdetail'</span>,false);toc;
<span class="comment">% Visualize the results</span>
w = warning (<span class="string">'off'</span>,<span class="string">'all'</span>);
m.view_gates(d,marker(marker_idx),<span class="string">'ignore_small'</span>,3000,<span class="string">'n_lines'</span>,4);
warning(w);
m.show_f_score(label);
</pre><pre class="codeoutput">Elapsed time is 683.784486 seconds.
Population	Gate	    TP	    FP	    FN	F-score
         1	  29	 15390	   534	  1172	  0.947
         2	  47	  6683	   255	   544	  0.944
         3	  26	 10863	 14070	  1338	  0.585
         4	  44	 19313	    85	   822	  0.977
         5	  53	  9833	   301	  1164	  0.931
         6	  26	 13421	 11512	   784	  0.686
         7	   4	 13324	    35	   442	  0.982
         8	  54	 29331	   833	  1526	  0.961
         9	  28	  6993	   460	   398	  0.942
        10	  56	  7804	   218	   726	  0.943
Normalized Mutual Information = 0.859
</pre><img vspace="5" hspace="5" src="html/demo_06.png" alt=""> <img vspace="5" hspace="5" src="html/demo_07.png" alt=""> <p class="footer"><br><a href="http://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2016b</a><br></p></div><!--
##### SOURCE BEGIN #####
%% Generating 2D Gating Hierarhcy from Clustered Cytometry Data
% Our algorithm cluster-to-gates(C2G) can visualize a clustered cytometry
% data in 2D gating hierarchy. The overall input to C2G are two variables:
% "data" and "label". "data" is a N-by-M matrix where N is the number of
% cells and M is the number of markers. "label" is a N-by-1 matrix and this
% matrix represent which cluster each cell belongs to (0 for ungated
% cells).  In this page, we will demonstrate how to use C2G to generate
% gating hierarchy on a simulated data and on a CYTOF dataset that are
% manually gated.
% The software and testing data can be downloaded *here* . 

%% Initialization and load the simulated data
% This simulated data set contain 20000 cells, which consist of 5
% populations.Two of the populations are addressed as known and labeled as
% 1 and 2. The cells in other populations are labeled 0 which means
% "ungated". A visualization of the original data is also shown in the
% following sections.
addpath('src')
addpath('libs')
load('testdata/simulated.mat','data','label');
markernames ={'Marker 1','Marker 2','Marker 3'};
fprintf('Size of "data" is %d-by-%d\n',size(data));
fprintf('Size of "label" is %d-by-%d\n',size(label));

%% Visualize the simulated data and pre-clustered simulated data in 3D
% In real application, this section is not necessay.
col = [0.8 0.8 0.8;hsv(length(unique(label))-1)];
figure('Position',[680 478 560 420]);
scatter3(data(:,1),data(:,2),data(:,3),1,col(label+1,:));
xlabel('Marker 1')
ylabel('Marker 2')
zlabel('Marker 3')
axis([-5 15 -5 15 -5 15]);

%% Run the analysis on the simulated data
% This section perform the analysis on the simulated data. If your data
% have no "ungated" cells, preclustered step can be skipped. If you skip
% precluster, the second and third parameter in function "C2G" should be
% the same. Compute local density step is also optional, it can decrease
% time cost in computing density when you want to try different parameter
% setting in "C2G". If you skipped it, no need to input the fourth
% parameter in "C2G".

% Precluster the simulated data
rng(9464);
preclustered_label = cluster_ungated(data,label);

% Call main part of the program and return a object m that store the
% results. The option "ignore_ratio" mean percentage of low density cells
% ignored when compute overlap between different populations

m = C2G(data,preclustered_label,label,'markernames',markernames,'showdetail',false); 
% Draw the obtained gating hierarchy
% Show statistics
m.view_gates(data,markernames,'n_lines',1,'onepanel',true);
outtable = m.show_f_score(label); 

%% Load CYTOF datasets
% Read multiple fcs files. Each fcs file correspond to one cell population
% Automatically generate cell labels based on fsc files. FCS files are
% store in the "test" folder. "CD4_Effmen.fcs", "CD4_naive.fcs", and
% "CD8_naive.fcs" are cells of target populations and "ctr.fcs" contain all
% cells. Only work with surface protein markers. 
clear
close all
addpath('src')
addpath('libs')
fdname = 'testdata';
[ori_data,ori_l,ori_markers]=load_mul_fcs(fdname,'ctr.fcs');

surface_idx = [3 4 6 8 9 11 12 13 22 24 25 27];
data = ori_data(:,surface_idx);
markers = ori_markers(surface_idx);
n_markers = length(markers);

%% Generate gating hierarchy for manually gated populations

% Precluster the ungated cells
rng(9464)
label = cluster_ungated(data,ori_l);
% Perform the anlysis
m_ori = C2G(data,label,ori_l,'markernames',markers,'showdetail',false);
% Visualize the results
m_ori.view_gates(data,markers,'n_lines',3,'ignore_small',0,'onepanel',true);
m_ori.show_f_score(ori_l);

%% Generate gating hierarchy for K-means defined populations (K=10)
rng(9464)
km_l = kmeans(data,10);
new_km_l = km_l; % Since all populiations is known, no need to pre-cluster
% Perform the anlysis
m_km = C2G(data,km_l,km_l,'markernames',markers,'showdetail',false);
% Visualize the results
m_km.view_gates(data,markers,'n_lines',4,'ignore_small',200);
m_km.show_f_score(km_l);

%% Scaffold CyTOF data
% This is a larger CyTOF dataset with 140k cells and 21 protein markers.
% This dataset is clustered by k-means where k equal to 10. This part will
% take around 10 minutes on a desktop. 
[ori_data, marker] = readfcs_v2('testdata/bigdata/TIN_BLD1_Untreated_Day3.fcs');
% Transform the CyTOF
data = flow_arcsinh(ori_data,5);
% Select protein markers
marker_idx = [10,16,17,18,19,21,22,24,29,31,32,33,39,40,41,46,47,49,50,51,52];
d = data(marker_idx,:)';
rng(9464);
label = kmeans(d,10);
% Perform the anlysis
tic;m = C2G(d, label, label,'markernames',marker(marker_idx),'showdetail',false);toc;
% Visualize the results
w = warning ('off','all');
m.view_gates(d,marker(marker_idx),'ignore_small',3000,'n_lines',4);
warning(w);
m.show_f_score(label);
##### SOURCE END #####
--></body></html>